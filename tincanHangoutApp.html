<html>
<style type="text/css">
<!--
.button {
  border-radius: 3px;
  -moz-border-radius: 3px;
  background: -webkit-gradient(linear, left top, left bottom, from(#fff), to(#ddd));
  background: -moz-linear-gradient(top, #fff, #ddd);  
  border: 1px solid #bbb;
}

.button:active {
	background: -webkit-gradient(linear, left top, left bottom, from(#aaa), to(#333)); 
	background: -moz-linear-gradient(bottom, #ddd, #aaa); }

-->
</style>
<body>

<!-- hangout.js is different for developer sandbox and production -->
<script type="text/javascript" src="//hangoutsapi.talkgadget.google.com/hangouts/_/api/hangout.js?v=1.2"></script>
<script type="text/javascript" src="https://rawgithub.com/RusticiSoftware/TinCanJS/master/build/tincan-min.js"></script>
<script type="text/javascript" src="https://rawgithub.com/RusticiSoftware/TinCanStatementViewer/master/scripts/base64.js"></script>

<h3>Tincan Hangout App</h3>

<p>
<input class="button" type="button" value="Show TinCan statements!" id="showParticipants" 
    style="visibility:hidden;"
    onClick="showTincanStatements()"/>
</p>

<div id="outputDiv"></div>

<script>
var tinCan;
gadgets.util.registerOnLoadHandler(init);  

function log(msg) {
	if (console && console.log) {
		console.log("TinCanApp: " + msg);
	}
}

function init() {
	log("init");

	// Initialize TinCan
	//TinCan.enableDebug();	
	/*
	tincan = new TinCan (
		{
			recordStores: [
				{
					endpoint: "https://cloud.scorm.com/ScormEngineInterface/TCAPI/public/",
					auth: 'Basic ' + Base64.encode('test:password')
				}
			]
		}
	);
	*/
	
	// Register to be notified when the hangout API is ready
	gapi.hangout.onApiReady.add( function(eventObj) {
		try { 
			if (eventObj.isApiReady) { 
					startApp(); 
			}
		} catch (e) { 
			console.log(e.stack); 
		}
	});
}

// Sends a TinCan Statement for this client if one hasn't yet been sent
function startApp() {
	log("Executing logic...");
	//document.getElementById('showParticipants').style.visibility = 'visible';

	/* DEBUG
	var hangoutObj = gapi.hangout;
	if (gapi)
		log("gasi defined");
	
	if (gapi.hangout)
		log("gapi.hangout defined");
		
	if (gapi.hangout.onParticipantsEnabled.add)
		log("gapi.hangout.onParticipantsEnabled.add defined");
		
	for (var prop in gapi.hangout) {
		log(prop);
	}
	*/
	
	
	// Get the local participant
	var participant = gapi.hangout.getLocalParticipant();
	// Get their google+ id
	var participantId = participant.person.id;
	
	// Check hangout's state to see if an entry has been added for this participant
	if (gapi.hangout.data.getValue(participantId)) {
		log("TinCan Statement has already been sent for local participant.");
		return;
	} else {
		log("Participant needs to generate TinCan statement.");
	}
	
	// Construct a TinCan statement for this user
	var statement = buildTinCanStatement();
	
}

// Builds a TinCan statement for the local paticipant attending this hangout
function buildTinCanStatement() {
	var participant = gapi.hangout.getLocalParticipant();
	for (var prop in participant.person) {
		log(prop);
	}
	log(participant.person.id);
}

function showTincanStatements() {
/*
  var participants = gapi.hangout.getParticipants();

  var retVal = '<p>Participants: </p><ul>';

  for (var index in participants) {
    var participant = participants[index];

    if (!participant.person) {
      retVal += '<li>A participant not running this app</li>';
    }
    retVal += '<li>' + participant.person.displayName + '</li>';
  }

  retVal += '</ul>';

  var div = document.getElementById('outputDiv');

  div.innerHTML = retVal;
  */
}                                                
</script>
</body>