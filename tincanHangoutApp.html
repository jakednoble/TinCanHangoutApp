<style type="text/css">

</style>

<!-- hangout.js is different for developer sandbox and production -->
<script type="text/javascript" src="//hangoutsapi.talkgadget.google.com/hangouts/_/api/hangout.js?v=1.2"></script>
<script type="text/javascript" src="https://rawgithub.com/RusticiSoftware/TinCanJS/master/build/tincan.js"></script>
<script type="text/javascript" src="https://rawgithub.com/RusticiSoftware/TinCanStatementViewer/master/scripts/base64.js"></script>

<h3>Tincan Hangout App</h3>

<p>
<input class="button" type="button" value="Show TinCan statements!" id="showParticipants" 
    style="visibility:hidden;"
    onClick="showTincanStatements()"/>
</p>

<div id="outputDiv"></div>

<script>
var tinCan;
gadgets.util.registerOnLoadHandler(init);  

function log(msg) {
	if (console && console.log) {
		console.log("TinCanApp: " + msg);
	}
}

function init() {
	log("init");

	// Initialize TinCan
	//TinCan.enableDebug();	
	tinCan = new TinCan (
		{
			recordStores: [
				{
					endpoint: "https://cloud.scorm.com/ScormEngineInterface/TCAPI/public/",
					auth: 'Basic ' + Base64.encode('test:password')
				}
			]
		}
	);
	
	// IE8 Compatibility
	/*
	if (!Date.now) {
		Date.now = function now() {
			return +(new Date);
		};
	}
	*/
	
	// Register to be notified when the hangout API is ready
	gapi.hangout.onApiReady.add( function(eventObj) {
		try { 
			if (eventObj.isApiReady) { 
					startApp(); 
			}
		} catch (e) { 
			console.log(e.stack); 
		}
	});
}

// Sends a TinCan Statement for this client if one hasn't yet been sent
function startApp() {
	log("Executing logic...");
	//document.getElementById('showParticipants').style.visibility = 'visible';
	
	// Get the local participant's google+ id
	var participant = gapi.hangout.getLocalParticipant();
	var participantId = participant.person.id;
	
	// Check hangout's state to see if this participant has already sent a TinCan statement for attending
	if (gapi.hangout.data.getValue(participantId)) {
		log("TinCan Statement has already been sent for local participant.");
		// If app reqs expand to show the statement to the user, code should branch to retrieve it here
		return;
	} else {
		log("Participant needs to generate TinCan statement.");
	}
	
	// Construct a TinCan statement for this user
	var statement = buildTinCanStatement();
	log("TinCan statement built.");
	
	// Send the statement
	tinCan.sendStatement(statement, 
		function(err, xhr) {
			if (err === null) {
				log("Statement sent successfully!");
				// Mark participant as having sent statement in the hangout's state
				gapi.hangout.data.setValue(participantId, "true");
			} else {
				log("There was an error sending the statement:");
				log(err);
			}
		}
	);

	log("Done!");
}

// Builds a TinCan statement for the local paticipant attending this hangout
function buildTinCanStatement() {
	log("Getting participant...");
	var participant = gapi.hangout.getLocalParticipant();
	
	log("Getting participant name...");
	var actorName = participant.person.displayName;
	var actorAccountHomePage = "https://plus.google.com";
	log("Getting participant id...");
	var actorAccountId = participant.person.id;
	log("Generating activity URI...");
	var timestamp = Date.now();
	var activityUri = generateActivityUri(timestamp);
	
	var statement = new TinCan.Statement( {
			actor: {
				objectType: "Agent",
				name: actorName,
				account: {
					homePage: actorAccountHomePage,
					name: actorAccountId
				}
			},
			verb: {
				id: "http://adlnet.gov/expapi/verbs/attended",
				display: {"en-US": "attended"}
			},
			object: {
				objectType: "Activity",
				id: activityUri,
				definition: {
					name: {"en-US": "Google Hangout"}
				}
			}
		});
		
	// TODO: Sync timestamps?
	// Display message?
	
	return statement;
}

// Generates a unique and exclusive URI for this hangout room. Uses the given TinCan statement if provided.
// Essentially, the resulting URI consists of the hangout URL concatenated with a query string
// containing a timestamp of the first statement sent from the hangout, in epoch time.
function generateActivityUri(defaultTimestamp) {
	// Check to see if the ActivityTimestamp key has been set in the hangout state
	// NOTE: Possible race condition
	log("Getting activity timestamp...");
	var activityTimestamp = gapi.hangout.data.getValue("ActivityTimestamp");
	log("Checking activity timestamp...");
	if (! activityTimestamp) {
		// This participant is the first to generate the activity uri and must set up the timestamp.
		log("Activity timestamp doesn't exist. Creating...");
		activityTimestamp = defaultTimestamp;
		log("Setting activity timestamp...");
		gapi.hangout.data.setValue("ActivityTimestamp", activityTimestamp.toString());
	}
	
	var activityUri = gapi.hangout.getHangoutUrl() + "?time=" + activityTimestamp;
	log("activityUri created successfully");
	log(activityUri);
	return activityUri;
}

function showTincanStatements() {
/*
  var participants = gapi.hangout.getParticipants();

  var retVal = '<p>Participants: </p><ul>';

  for (var index in participants) {
    var participant = participants[index];

    if (!participant.person) {
      retVal += '<li>A participant not running this app</li>';
    }
    retVal += '<li>' + participant.person.displayName + '</li>';
  }

  retVal += '</ul>';

  var div = document.getElementById('outputDiv');

  div.innerHTML = retVal;
  */
}                                                
</script>